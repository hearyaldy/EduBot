rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is superadmin
    function isSuperadmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.accountType == 'superadmin';
    }
    
    // Helper function to check if user is admin or superadmin
    function isAdminOrSuperadmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.accountType == 'superadmin' ||
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.accountType == 'admin');
    }

    // AI Generated Lessons - Created by admins
    match /aiLessons/{lessonId} {
      // Anyone authenticated can read AI lessons
      allow read: if request.auth != null;

      // Only admins and superadmins can create/update/delete AI lessons
      allow write: if isAdminOrSuperadmin();
    }

    // Lessons collection - for general lessons
    match /lessons/{lessonId} {
      // Anyone authenticated can read lessons
      allow read: if request.auth != null;

      // Only admins and superadmins can write lessons
      allow write: if isAdminOrSuperadmin();
    }

    // Question Bank - Global shared questions
    match /questionBank/{questionId} {
      // Anyone can read questions
      allow read: if true;

      // Only authenticated users can write questions
      allow write: if request.auth != null;
    }

    // User profiles
    match /users/{userId} {
      // Users can read their own profile OR superadmins can read all profiles
      allow read: if request.auth != null && 
                    (request.auth.uid == userId || isSuperadmin());

      // Users can write their own profile OR superadmins can write all profiles
      allow write: if request.auth != null && 
                     (request.auth.uid == userId || isSuperadmin());
    }

    // Child profiles (nested under users) - using childProfiles subcollection
    match /users/{userId}/childProfiles/{childId} {
      // Users can read their own children's profiles
      allow read: if request.auth != null && request.auth.uid == userId;

      // Users can write their own children's profiles
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Also support the children subcollection for backwards compatibility
    match /users/{userId}/children/{childId} {
      // Users can read their own children's profiles
      allow read: if request.auth != null && request.auth.uid == userId;

      // Users can write their own children's profiles
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Student progress (nested under children)
    match /users/{userId}/children/{childId}/progress/{progressId} {
      // Users can read their own children's progress
      allow read: if request.auth != null && request.auth.uid == userId;

      // Users can write their own children's progress
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Questions submitted by users (user-specific)
    match /users/{userId}/questions/{questionId} {
      // Users can read their own questions
      allow read: if request.auth != null && request.auth.uid == userId;

      // Users can write their own questions
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // History/submissions
    match /users/{userId}/history/{historyId} {
      // Users can read their own history
      allow read: if request.auth != null && request.auth.uid == userId;

      // Users can write their own history
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Badges
    match /users/{userId}/badges/{badgeId} {
      // Users can read their own badges
      allow read: if request.auth != null && request.auth.uid == userId;

      // Users can write their own badges
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Practice Sessions (nested under users)
    match /users/{userId}/practiceSessions/{sessionId} {
      // Users can read their own practice sessions
      allow read: if request.auth != null && request.auth.uid == userId;

      // Users can write their own practice sessions
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Admin collection (super restricted)
    match /admin/{document=**} {
      // Only allow if user has custom claim 'admin: true'
      allow read, write: if request.auth != null &&
                            request.auth.token.admin == true;
    }

    // Deny all other paths by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}