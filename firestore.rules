rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Question Bank - Global shared questions
    match /questionBank/{questionId} {
      // Anyone can read questions
      allow read: if true;

      // Only authenticated users can write questions
      allow write: if request.auth != null;
    }

    // User profiles
    match /users/{userId} {
      // Users can read their own profile
      allow read: if request.auth != null && request.auth.uid == userId;

      // Users can write their own profile
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Child profiles (nested under users)
    match /users/{userId}/children/{childId} {
      // Users can read their own children's profiles
      allow read: if request.auth != null && request.auth.uid == userId;

      // Users can write their own children's profiles
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Student progress (nested under children)
    match /users/{userId}/children/{childId}/progress/{progressId} {
      // Users can read their own children's progress
      allow read: if request.auth != null && request.auth.uid == userId;

      // Users can write their own children's progress
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Questions submitted by users (user-specific)
    match /users/{userId}/questions/{questionId} {
      // Users can read their own questions
      allow read: if request.auth != null && request.auth.uid == userId;

      // Users can write their own questions
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // History/submissions
    match /users/{userId}/history/{historyId} {
      // Users can read their own history
      allow read: if request.auth != null && request.auth.uid == userId;

      // Users can write their own history
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Badges
    match /users/{userId}/badges/{badgeId} {
      // Users can read their own badges
      allow read: if request.auth != null && request.auth.uid == userId;

      // Users can write their own badges
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Admin collection (super restricted)
    match /admin/{document=**} {
      // Only allow if user has custom claim 'admin: true'
      allow read, write: if request.auth != null &&
                            request.auth.token.admin == true;
    }

    // Deny all other paths by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}